.. _running_factor:

Running Factor
==============

Factor can be run with::

    $ runfactor factor.parset

where ``factor.parset`` is the parset described in :ref:`factor_parset`). A number of options are available::

    Usage: runfactor parset

    Options:
      --version             show program's version number and exit
      -h, --help            show this help message and exit
      -d                    enable dry-run mode
      -q                    enable quiet mode
      -r RESET, --reset=RESET
                            comma-separated list of directions to reset (e.g., -r
                            facet1,facet3)
      -o OPS, --ops=OPS     comma-separated list of operations to reset for the
                            directions specified with "-r or --reset" (e.g., -o
                            facetselfcal,facetsub). By default, all operations are
                            reset. Available operations are: outlierpeel,
                            facetpeel, facetpeelimage, facetselfcal, facetsub,
                            facetimage, fieldmosaic
      -t                    enable test mode
      -v                    enable verbose mode


You can check the progress of a run with::

    $ checkfactor factor.parset

.. note::

    A number of ``checkfactor`` options are configurable in the Factor parset (see :ref:`parset_checkfactor_options`).

A brief overview of the initialization, processing, and output generated by Factor are described below.


Tutorials
---------

A number of tutorials describing how to set up a Factor run, how to interpret the output, and how to deal with common problems is available in the LOFAR Imaging Cookbook at http://www.astron.nl/radio-observatory/lofar/lofar-imaging-cookbook.


Initialization
--------------

Factor will begin by checking the input measurement sets and the direction-independent instrument tables. If the instrument tables contain real/imaginary values, they are converted the phase/amplitude. The input measurement sets are chunked in time to allow more efficient processing.

Next, Factor will check for a file describing the DDE calibrators. If not found, Factor will select the DDE calibrators automatically and generate the facet regions (saved in a text file in the working directory called ``factor_directions.txt``). At this point, if ``interactive = True`` is set in the parset, Factor will pause to allow a check on the facets.


Self calibration and imaging
----------------------------

After intialization, Factor will begin self calibration and imaging (described in detail in :ref:`operations`) of the first facet or group of facets. For the facet or facets that pass self-calibration verification, Factor subtracts the improved model using the direction-dependent instrument tables. Processing then proceeds to the self calibration and imaging of the next facet or facet group, and the step are looped until all facets have been processed.

After self calibration is finished, imaging is done for any facets that did not successfully go through self calibration. These facets receive the direction-dependent instrument tables of the nearest facet for which self calibration succeeded. Lastly, all facet images are mosaicked together and the primary beam attenuation is corrected to produce the final image.


Processing
----------

Factor uses the LOFAR pipeline framework to handle the actual processing. The LOFAR pipeline framework handles the distribution of jobs and keeps track of the state of a reduction. Each Factor operation is done in a separate pipeline. See :ref:`structure` for an overview of the various operations that Factor performs and their relation to one another, and see :ref:`operations` for details of each operation.


Resuming an interrupted run
---------------------------

Due to the potentially long run times and the consequent non-negligible chance
of some unforeseen failure occurring, Factor has been designed to allow easy
resumption of a reduction from a saved state and will skip over any steps that
were successfully completed previously. In this way, one can quickly resume a
reduction that was halted (either by the user or due to some problem) by simply
re-running Factor with the same parset.

For example, one can specify that only the first 5 directions be processed.
Once these directions are done, Factor will exit. One can then alter the parset
and specify that 10 directions should be done. Upon restarting, Factor will skip
over the first 5 directions and start with the 6th one (and ending with the 10th
one).

.. note::

    Upon resuming a run, Factor will pick up changes to the parset and directions file. However, changes that alter the facet layout will result in incorrect results, as Factor does not handle these properly.


Resetting a direction
---------------------

Factor allows for the processing of a direction to be reset. Resetting involves deleting the output products, resetting the state (which tracks which operations have been completed), and if necessary undoing the subtraction of the model resulting from self calibration and the imaging of the facet. Directions can be reset using the "-r" flag to ``runfactor``. For example, to reset all operations for direction1 and direction2::

    $ runfactor factor.parset -r direction1,direction2

Additionally, one or more specific operations can reset by including "-o" flag. For example, the following would reset only the facetimage operation for direction1 and direction2::

    $ runfactor factor.parset -r direction1,direction2 -o facetimage


Output
------

Factor produces the following output inside the working directory:

``factor.log``
    Log file containing only the higher-level log messages. Detailed logs for each operation are available in the ``logs`` directory (see below).

``factor_directions.txt``
    Optional file listing the DDE calibrators. This file is generated only when no directions file is supplied by the user.

``chunks/``
    Directory containing the time-chunked datasets that Factor uses for processing.

``logs/``
    Directory containing the detailed operation logs.

    .. note::

        The log of each operation is stored as ``logs/operation_name/direction_name.out.log``. For example, the log of the ``facetselfcal`` operation for a direction named ``facet_patch_200`` will be stored in ``logs/facetselfcal/facet_patch_200.out.log``.

    .. note::

        Some error messages are stored in the ``logs/operation_name/direction_name.err.log`` file, but these are rarely of interest. Generally, important error messages will appear in the ``logs/operation_name/direction_name.out.log`` file. These log files are very large, so a search for "error" is usually the easiest way to find any error messages.

``regions/``
    Directory containing the ds9 region files for the facet and self-calibration images. The following region files are made:

    * ``calimages_ds9.reg`` - the self-calibration image regions. The inner box shows the area over which sources are added back and cleaned. The outer box shows the area that is imaged.
    * ``facets_ds9.reg`` - the facet image regions.

``results/``
    Directory containing the results (images, etc.) of each operation. See :ref:`operations` for details of the primary output products of each operation.

    .. note::

        The output of each operation is stored in a directory named ``results/operation_name/direction_name/``. For example, the results of the ``facetselfcal`` operation for a direction named ``facet_patch_200`` will be stored in ``results/facetselfcal/facet_patch_200/``.

``state/``
    Directory containing files that save the state of a reduction.
